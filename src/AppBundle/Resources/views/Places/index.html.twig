{% extends 'AppBundle:Admin:index.html.twig' %}

 {% block mainAdminContent %}
     <div class="page-title" xmlns="http://www.w3.org/1999/html">
         <h3>{{ "Список площадок" | trans }}</h3>
     </div>

     <div class="row">
         <div class="col-md-12">
             <div class="grid simple">

                 <div class="grid-body no-border"> <br>
                     <div class="row">

                         <table class="table table-bordered">
                             <thead>
                             <tr>
                                 <th>Группы</th>
                                 <th>Рубрики</th>
                                 <th>Блоки / Действия / CTR</th>
                                 {#<th>Действия</th>#}
                                 {#<th>CTR</th>#}
                             </tr>
                             </thead>
                             <tbody>
                             {% for placeId, place in places %}
                                 <tr class="" style="color:#fff;border-top:2px solid #cc0000">
                                     <td colspan="5" data-id="{{ placeId }}" class="placeId">
                                         <h3>
                                             <div class="btn-group btn-group-sm">
                                                 <button title="Редактировать" class="btn"><i class="fa fa-pencil"></i></button>
                                                 {#<button title="Клонировать" class="btn btn-primary"><i class="fa fa-files-o"></i></button>#}
                                                 <button onclick="window.open('{{ place.name }}', '_blank')" title="Посмотреть сайт в новом окне" class="btn btn-success"><i class="fa fa-external-link"></i></button>
                                             </div>
                                             {{ place.name }}
                                         </h3>
                                     </td>
                                 </tr>
                                 {% for r in place.row %}
                                     <tr>
                                         <td data-id="{{ r.g_id }}">{{ r.g_name }}</td>
                                         <td data-id="{{ r.r_id }}">
                                             {{ r.r_name }}
                                             <a href="" data-pid="{{ placeId }}" data-rid="{{ r.r_id }}" data-gid="{{ r.g_id }}" title="Добавить блок" class="btn btn-warning addBlockToPlace" data-for="{{ r.g_name ~ '/' ~ r.r_name }}"><i class="fa fa-plus"></i></a>
                                         </td>
                                         <td style="padding:0 !important">

                                             <ul class="list-group">

                                                 {{ dump(places) }}

                                                 {#{% for block in places.blocks %} &#123;&#35;add blocks for place TODO&#35;&#125;#}
                                                     {#<li data-block-id="{{ block.id }}" class="list-group-item">#}
                                                         {#<span class="label">{{ block.name }}</span>#}
                                                         {#<span class="pull-right" style="margin-left:1em">#}
                                                             {#<span class="btn btn-success disabled">{{ "-" }}%</span>#}
                                                         {#</span>#}
                                                         {#<div class="btn-group btn-group-mini pull-right">#}
                                                             {#<a href="" data-pid="{{ placeId }}" data-rid="{{ r.r_id }}" data-gid="{{ r.g_id }}" title="Получить код для вставки" class="btn btn-success getEmbedCodeBtn"><i class="fa fa-code"></i></a>#}
                                                             {#<a href="" title="Статистика" class="btn btn-default"><i class="fa fa-bar-chart-o"></i></a>#}
                                                             {#<a href="" target="_blank" title="Открыть в новой вкладке" class="btn btn-default"><i class="fa fa-folder-o"></i></a>#}
                                                             {#<a href="" title="Удалить" class="btn btn-danger"><i class="fa fa-times"></i></a>#}
                                                         {#</div>#}
                                                         {#<div class="clear clearfix"></div>#}
                                                     {#</li>#}
                                                 {#{% endfor %}#}
                                             </ul>
                                         </td>
                                     </tr>
                                 {% endfor %}
                             {% endfor %}
                             </tbody>
                         </table>
                         <div class="clear clearfix"></div>
                     </div>
                 </div>
             </div>
         </div>
     </div>

 {% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script type="text/template" id="addBlockToPlaceTemplate">
        <div id="addBlockToPlaceDiv">

            <div class="panel-danger error" style="display: none">
                Нужно что-то выбрать!
            </div>

            <input type="hidden" class="placeid" value="{0}" />
            {% if blocks %}
            {% for block in blocks if blocks %}
                <div class="radio radio-primary radio-circle">
                    <input name="block" type="radio" value="{{ block.id }}" id="{{ block.id }}">
                    <label for="{{ block.id }}">{{ block.blockName }}</label>
                </div>
            {% endfor %}
            <div class="clearfix clear"></div>
            <button class="btn btn-primary col-lg-12" id="addBlockButton">{{ "Save" | trans }}</button>
            {% else %}
                <span class="panel panel-warning">No blocks here. <a class="btn btn-primary btn-mini" href="{{ path('admin_places_add_block') }}">Create one now</a></span>
            {% endif %}
        </div>
    </script>

    <script type="text/javascript">
        var saveRubricsUrl = "{{ path('admin_add_rubrics') }}";
        var addBlockToPlaceUrl = "{{ path('admin_add_block_to_place') }}";
        var deleteRubricsUrl = "{{ path('admin_delete_rubrics') }}";
        var getEmbedCodeUrl = "{{ path('admin_places_get_embed_code') }}";

        $(document).ready(function(){
            $('a.getEmbedCodeBtn').on('click', function(e){
                e.preventDefault();

                var gid = $(this).data('gid')-0;
                var rid = $(this).data('rid')-0;
                var pid = $(this).data('pid')-0;

                $.post(getEmbedCodeUrl, {
                    gid: gid,
                    rid: rid,
                    pid: pid
                }, function(r){
                    if ( r.msg == 'success' ){
                        var modal = new MyAlert( "{{ 'Embed code' | trans }}", r.content );
                        modal.show();
                    }
                }, 'json');
                return false;
            });

            $('.addBlockToPlace').on('click', function(e){
                e.preventDefault();

                var placeName = $(this).data('for');
                var placeId = $(this).data('pid');

//                $('#addBlockToPlaceTemplate').find('.placeId').attr('value',placeId);

                var addBlockToPlaceTemplate = $('#addBlockToPlaceTemplate').html();
                addBlockToPlaceTemplate = addBlockToPlaceTemplate.replace('{0}', placeId);

                var myModal = new MyAlert(
                        "{{ 'Add block for ' | trans }}\"" + placeName + "\"",
                        addBlockToPlaceTemplate
                );
                myModal.show();

            });
            $('#myAlert').on('shown.bs.modal', function () {
                $(document).on('click', '.modal-body #addBlockButton', function(){

                    var blockId = $(this).parent().find('input[name="block"]:checked').val();
                    var placeId = $(this).parent().find('.placeid').val();

                    if ( typeof blockId == 'undefined' || typeof placeId == 'undefined' ) {
                        $(this).parent().find('.error').slideDown().delay(2000).slideUp();
                        return false;
                    }

                    $.post(addBlockToPlaceUrl, {
                        blockId: blockId,
                        placeId: placeId
                    }, function(r){
                        if(r.msg == 'success') {

                        }
                    }, 'json');
                });
            });

        });
    </script>

    <script type="text/javascript" src="{{ asset('/bundles/app/js/settings/master.js') }}"></script>
{% endblock %}
